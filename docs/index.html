<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
  <head>
    <meta charset="UTF-8" />
    <title>JSON Query - a small, flexible, and expandable JSON query language</title>
    <link rel="stylesheet" href="style.css" />
    <meta name="description" content="Repair broken JSON documents" />
    <meta name="keywords" content="json, repair, simple, json-simple-repair, fix, invalid" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="frog-756900-100.png" />
  </head>
  <body>
    <div class="app">
      <div class="header">
        <div class="header-contents">
          <!-- source: https://pixy.org/756900/ -->
          <img
            src="frog-756900-100.png"
            srcset="frog-756900-200.png 2x"
            alt="JSON Query logo"
            class="header-icon"
            width="100"
            height="98"
          />
          <div class="header-text">
            <h1>JSON Query</h1>
            <p>A small, flexible, and expandable JSON query language.</p>
            <p>
              Documentation:
              <a href="https://github.com/josdejong/jsonquery">
                https://github.com/josdejong/jsonquery
              </a>
            </p>
          </div>
        </div>
      </div>
      <div class="examples">
        <div class="examples-inner">
          <button class="example" id="example1">example 1</button>
          <button class="example" id="example2">example 2</button>
          <button class="example" id="example3">example 3</button>
          <button class="example" id="example4">example 4</button>
          <button class="example" id="example5">example 5</button>
        </div>
      </div>
      <div class="playground">
        <div class="column">
          <label for="input-text">Input</label>
          <textarea id="input-text" autocomplete="off" autocapitalize="off" spellcheck="false">
{
  "friends": [
    {"name": "Chris", "age": 23, "city": "New York"},
    {"name": "Emily", "age": 19, "city": "Atlanta"},
    {"name": "Joe", "age": 32, "city": "New York"},
    {"name": "Kevin", "age": 19, "city": "Atlanta"},
    {"name": "Michelle", "age": 27, "city": "Los Angeles"},
    {"name": "Robert", "age": 45, "city": "Manhattan"},
    {"name": "Sarah", "age": 31, "city": "New York"}
  ]
}</textarea
          >
        </div>
        <div class="column">
          <label for="query-text">Query</label>
          <textarea id="query-text" autocomplete="off" autocapitalize="off" spellcheck="false">
[
  ["get", "friends"],
  ["filter", "city", "==", "New York"],
  ["sort", "age"],
  ["pick", "name", "age"]
]</textarea
          >
        </div>
        <div class="column">
          <label for="output-text">Output</label>
          <button type="button" id="show-debugger">Debug</button>
          <textarea id="output-text" readonly>loading...</textarea>
        </div>
        <div class="column">
          <label for="output-text">Quick Reference</label>
          <div class="quick-reference">
            <details>
              <summary>
                <span class="category">Function</span>
                <code>[name, argument1, argument2, ...]</code>
              </summary>
              <div class="details-content">
                <p>
                  A <b>function</b> is an array with the function name as first item followed by
                  optional function arguments.
                </p>
                <p>Example: <code>["sort", ["address", "city"], "asc"]</code></p>
                <p>
                  Documentation:
                  <a
                    href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md"
                    target="_blank"
                    >Functions</a
                  >
                </p>
                <p>Function reference:</p>
                <ul class="function-reference">
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#get"
                      target="_blank"
                      ><code>["get", path]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#filter"
                      target="_blank"
                      ><code>["filter", condition]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#filter"
                      target="_blank"
                      ><code>["filter", left, operator, right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#sort"
                      target="_blank"
                      ><code>["sort", path, direction]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#pick"
                      target="_blank"
                      ><code>["pick", path1, path2, ...]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#map"
                      target="_blank"
                      ><code>["map", query]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#groupBy"
                      target="_blank"
                      ><code>["groupBy", path]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#keyBy"
                      target="_blank"
                      ><code>["keyBy", path]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#keys"
                      target="_blank"
                      ><code>["keys"]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#values"
                      target="_blank"
                      ><code>["values"]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#flatten"
                      target="_blank"
                      ><code>["flatten"]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#uniq"
                      target="_blank"
                      ><code>["uniq"]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#uniqBy"
                      target="_blank"
                      ><code>["uniqBy", path]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#limit"
                      target="_blank"
                      ><code>["limit", size]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#size"
                      target="_blank"
                      ><code>["size", path]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#string"
                      target="_blank"
                      ><code>["string", text]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#sum"
                      target="_blank"
                      ><code>["sum"]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#min"
                      target="_blank"
                      ><code>["min"]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#max"
                      target="_blank"
                      ><code>["max"]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#prod"
                      target="_blank"
                      ><code>["prod"]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#average"
                      target="_blank"
                      ><code>["average"]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#abs"
                      target="_blank"
                      ><code>["abs"]</code></a
                    >
                  </li>
                  <li>
                    <a
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/functions.md#round"
                      target="_blank"
                      ><code>["round", digits]</code></a
                    >
                  </li>
                </ul>
              </div>
            </details>
            <details>
              <summary>
                <span class="category">Operator</span>
                <code>[left, operator, right]</code>
              </summary>
              <div class="details-content">
                <p>
                  An <b>operator</b> is an array with a left side value, the operator, and a right
                  side value. Operators are for example used in the <code>filter</code> function to
                  specify a condition.
                </p>
                <p>Example:</p>
                <pre><code>["filter", ["address", "city"], "==", "New York"]</code></pre>
                <p>
                  Documentation:
                  <a
                    href="https://github.com/josdejong/jsonquery/blob/main/reference/operators.md"
                    target="_blank"
                    >Operators</a
                  >
                </p>
                <p>Operator reference:</p>
                <ul class="operator-reference">
                  <li>
                    <a
                      title="equal"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#equal-"
                      target="_blank"
                      ><code>[left, "==", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="greater than"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#greater-than-"
                      target="_blank"
                      ><code>[left, ">", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="greater than or equal"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#greater-than-or-equal-"
                      target="_blank"
                      ><code>[left, ">=", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="less than"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#less-than-"
                      target="_blank"
                      ><code>[left, "<", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="less than or equal"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#less-than-or-equal-"
                      target="_blank"
                      ><code>[left, "<=", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="not equal"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#not-equal-"
                      target="_blank"
                      ><code>[left, "!=", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="and"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#and"
                      target="_blank"
                      ><code>[left, "and", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="or"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#or"
                      target="_blank"
                      ><code>[left, "or", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="not"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#not"
                      target="_blank"
                      ><code>["not", value]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="exists"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#exists"
                      target="_blank"
                      ><code>["exists", path]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="in"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#in"
                      target="_blank"
                      ><code>[left, "in", ...values]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="not in"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#not-in"
                      target="_blank"
                      ><code>[left, "not in", ...values]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="regex"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#regex"
                      target="_blank"
                      ><code>[left, "regex", expression, options]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="add"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#add-"
                      target="_blank"
                      ><code>[left, "+", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="subtract"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#subtract-"
                      target="_blank"
                      ><code>[left, "-", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="multiply"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#multiply-"
                      target="_blank"
                      ><code>[left, "*", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="divide"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#divide-"
                      target="_blank"
                      ><code>[left, "/", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="power"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#^power-"
                      target="_blank"
                      ><code>[left, "^", right]</code></a
                    >
                  </li>
                  <li>
                    <a
                      title="remainder"
                      href="https://github.com/josdejong/jsonquery/blob/main/reference/operatorss.md#^remainder-"
                      target="_blank"
                      ><code>[left, "%", right]</code></a
                    >
                  </li>
                </ul>
              </div>
            </details>
            <details>
              <summary>
                <span class="category">Property</span>
                <code>"property"</code>
              </summary>
              <div class="details-content">
                <p>A <b>property</b> is a string pointing to a value inside an object.</p>
                <p>Example: <code>"age"</code></p>
                <p>
                  Documentation:
                  <a
                    href="https://github.com/josdejong/jsonquery#properties-and-paths"
                    target="_blank"
                    >Properties and paths</a
                  >
                </p>
              </div>
            </details>
            <details>
              <summary>
                <span class="category">Path</span>
                <code>[property1, property2, ...]</code>
              </summary>
              <div class="details-content">
                <p>
                  A <b>path</b> is an array containing <i>properties</i>, describing a property in a
                  nested object.
                </p>
                <p>Example: <code>["address", "city"]</code></p>
                <p>
                  Documentation:
                  <a
                    href="https://github.com/josdejong/jsonquery#properties-and-paths"
                    target="_blank"
                    >Properties and paths</a
                  >
                </p>
              </div>
            </details>
            <details>
              <summary>
                <span class="category">Pipe</span>
                <code>[query1, query1, ...]</code>
              </summary>
              <div class="details-content">
                <p>
                  A <b>pipe</b> is an array containing a series of queries. The queries in the
                  pipeline are executed one by one, and the output of the first is the input for the
                  next.
                </p>
                <p>Example:</p>
                <pre><code>[
  ["sort", "age"],
  ["pick", "name", "age"]
]</code></pre>
                <p>
                  Documentation:
                  <a href="https://github.com/josdejong/jsonquery#pipes" target="_blank">Pipes</a>
                </p>
              </div>
            </details>
            <details>
              <summary>
                <span class="category">Object</span>
                <code>{"prop1": query1, "prop2": query2, ...}</code>
              </summary>
              <div class="details-content">
                <p>
                  An <b>object</b> is defined as a regular JSON object with a property name as key,
                  and a <i>function</i>, <i>pipe</i>, or <i>object</i> as value. Objects can be used
                  to transform data or to execute multiple query pipelines in parallel.
                </p>
                <p>Example:</p>
                <pre><code>{
  "names": ["map", "name"],
  "numberOfNames": ["length"]
}</code></pre>
                <p>
                  Documentation:
                  <a href="https://github.com/josdejong/jsonquery#objects" target="_blank"
                    >Objects</a
                  >
                </p>
              </div>
            </details>
          </div>
        </div>
      </div>
      <dialog id="debugger">
        <div class="dialog-header">
          <h3 class="title">Debugger</h3>
          <button type="button" id="close-dialog">Close</button>
        </div>
        <div class="dialog-contents">
          <div id="error-message">Error message...</div>
          <div class="stack-toggles">
            Stack: <button type="button" id="error-previous">Previous</button>
            <span id="error-index">2/4</span>
            <button type="button" id="error-next">Next</button>
          </div>
          <div class="debug-columns">
            <div class="debug-column">
              <label class="debug-label" for="error-data">Input</label>
              <textarea class="debug-content" id="error-data" readonly></textarea>
            </div>
            <div class="debug-column">
              <label class="debug-label" for="error-query">Query</label>
              <textarea class="debug-content" id="error-query" readonly></textarea>
            </div>
          </div>
        </div>
      </dialog>
    </div>

    <script type="module">
      import { jsonquery } from 'https://cdn.jsdelivr.net/npm/@josdejong/jsonquery/lib/jsonquery.js'

      window.jsonquery = jsonquery

      const refInputText = document.getElementById('input-text')
      const refQueryText = document.getElementById('query-text')
      const refOutputText = document.getElementById('output-text')
      const refShowDebugger = document.getElementById('show-debugger')
      const refDebugger = document.getElementById('debugger')
      const refCloseDebugger = document.getElementById('close-dialog')
      const refErrorMessage = document.getElementById('error-message')
      const refErrorPrevious = document.getElementById('error-previous')
      const refErrorNext = document.getElementById('error-next')
      const refErrorIndex = document.getElementById('error-index')
      const refErrorData = document.getElementById('error-data')
      const refErrorQuery = document.getElementById('error-query')

      const input1 = refInputText.value
      const query1 = refQueryText.value

      const input2 = refInputText.value
      const query2 = `[
  ["get", "friends"],
  ["filter", [
    ["city", "==", "New York"],
    "and",
    ["age", ">", 30]
  ]],
  ["sort", "age"],
  ["pick", "name", "age"]
]`

      const input3 = refInputText.value
      const query3 = `[
  ["get", "friends"],
  ["map", {
    "firstName": "name",
    "details": {
      "city": "city",
      "age": "age"
    }
  }]
]`

      const input4 = refInputText.value
      const query4 = `[
  ["get", "friends"],
  {
    "names": ["map", "name"],
    "count": ["size"],
    "averageAge": [
      ["map", "age"],
      ["average"]
    ]
  }
]`

      const input5 = `[
  { "name": "bread", "price": 2.5, "quantity": 2 },
  { "name": "milk", "price": 1.2, "quantity": 3 }
]`
      const query5 = `[
  ["map", ["price", "*", "quantity"]],
  ["sum"]
]`

      let error = undefined
      let errorIndex = 0

      function go() {
        try {
          const input = JSON.parse(refInputText.value)
          const query = JSON.parse(refQueryText.value)
          const output = jsonquery(input, query)

          refOutputText.value = JSON.stringify(output, null, 2)
          refOutputText.classList.remove('error')
          refShowDebugger.style.display = 'none'
          error = undefined
          errorIndex = 0
        } catch (err) {
          console.error(err)
          error = err

          if (err.jsonquery) {
            const lastQuery = err.jsonquery[err.jsonquery.length - 1].query
            refOutputText.value = `${err}\n\nWhilst executing the following part of the query:\n\n${JSON.stringify(lastQuery)}`
            refOutputText.classList.add('error')
            refShowDebugger.style.display = ''
          } else {
            refOutputText.value = String(err)
            refOutputText.classList.add('error')
          }
        }
      }

      function showDebugger() {
        if (error?.jsonquery) {
          errorIndex = error.jsonquery.length - 1
          renderDebugEntry()
          refDebugger.showModal()
        }
      }

      function previousDebugEntry() {
        if (errorIndex > 0) {
          errorIndex--
          renderDebugEntry()
        }
      }

      function nextDebugEntry() {
        if (errorIndex < error?.jsonquery?.length - 1) {
          errorIndex++
          renderDebugEntry()
        }
      }

      function renderDebugEntry() {
        const current = error?.jsonquery?.[errorIndex]
        if (current) {
          refErrorMessage.innerText = String(error)
          refErrorIndex.innerText = `${errorIndex + 1}/${error.jsonquery.length}`
          refErrorData.value = JSON.stringify(current.data, null, 2)
          refErrorQuery.value = JSON.stringify(current.query, null, 2)
        }
      }

      function load(input, query) {
        refInputText.value = input
        refQueryText.value = query
        go()
      }

      refInputText.addEventListener('input', go)
      refQueryText.addEventListener('input', go)
      refShowDebugger.addEventListener('click', showDebugger)
      refErrorPrevious.addEventListener('click', previousDebugEntry)
      refErrorNext.addEventListener('click', nextDebugEntry)
      refDebugger.addEventListener('click', (event) => {
        if (event.target === refDebugger) {
          // close when clicking outside the dialog
          refDebugger.close()
        }
      })
      refCloseDebugger.addEventListener('click', () => refDebugger.close())
      document.getElementById('example1').addEventListener('click', () => load(input1, query1))
      document.getElementById('example2').addEventListener('click', () => load(input2, query2))
      document.getElementById('example3').addEventListener('click', () => load(input3, query3))
      document.getElementById('example4').addEventListener('click', () => load(input4, query4))
      document.getElementById('example5').addEventListener('click', () => load(input5, query5))

      go()
    </script>
  </body>
</html>
